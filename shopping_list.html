{% extends "base.html" %}
{% block content %}

<!-- HEADER: BUDGET CONTROLS -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card border-0 shadow-sm bg-white">
            <div class="card-body">
                <form method="POST" class="row align-items-end">
                    <div class="col-md-4">
                        <label class="fw-bold text-muted small">MY BUDGET LIMIT</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" step="0.01" name="budget_amount" class="form-control fw-bold" value="{{ current_user.budget_amount }}" required>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="fw-bold text-muted small">DURATION</label>
                        <select name="budget_period" class="form-select">
                            <option value="Weekly" {% if current_user.budget_period == 'Weekly' %}selected{% endif %}>Weekly</option>
                            <option value="Monthly" {% if current_user.budget_period == 'Monthly' %}selected{% endif %}>Monthly</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" name="set_budget" value="1" class="btn btn-dark w-100">Set Budget</button>
                    </div>
                    <div class="col-md-3 text-end">
                         <label class="fw-bold text-muted small">CURRENT TOTAL</label>
                         <h3 class="mb-0 text-{{ 'danger' if total > current_user.budget_amount else 'success' }}">
                             ${{ "%.2f"|format(total) }}
                         </h3>
                    </div>
                </form>
                
                <!-- BUDGET PROGRESS BAR -->
                <div class="mt-3">
                    <div class="d-flex justify-content-between small text-muted mb-1">
                        <span>Spent: ${{ "%.2f"|format(total) }}</span>
                        <span>Remaining: ${{ "%.2f"|format(current_user.budget_amount - total) }}</span>
                    </div>
                    <div class="progress" style="height: 10px;">
                        <!-- FIX: ID added, inline style removed to prevent IDE errors -->
                        <div id="budgetProgressBar" 
                             class="progress-bar {{ 'bg-danger' if progress > 100 else 'bg-success' }}" 
                             role="progressbar">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- LEFT COL: SHOPPING LIST -->
    <div class="col-lg-7">
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0"><i class="fas fa-shopping-cart me-2"></i>Your Cart</h5>
                <a href="/clear_list" class="btn btn-sm btn-outline-danger">Clear All</a>
            </div>
            <div class="card-body p-0">
                <table class="table table-hover mb-0 align-middle">
                    <thead class="bg-light small text-muted">
                        <tr>
                            <th class="ps-4">Item Name</th>
                            <th>Est. Price</th>
                            <th class="text-end pe-4">Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                        <tr>
                            <td class="ps-4">
                                <span class="{{ 'text-primary' if item.added_by_ai else '' }}">
                                    {% if item.added_by_ai %}<i class="fas fa-robot me-1 small"></i>{% endif %}
                                    {{ item.item_name }}
                                </span>
                            </td>
                            <td class="fw-bold">${{ "%.2f"|format(item.estimated_price) }}</td>
                            <td class="text-end pe-4">
                                <a href="/remove_shop_item/{{ item.id }}" class="text-danger"><i class="fas fa-times"></i></a>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="3" class="text-center py-5 text-muted">
                                <i class="fas fa-basket-shopping fa-3x mb-3 opacity-50"></i>
                                <p>Your list is empty.</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- RIGHT COL: ADD ITEMS & AI -->
    <div class="col-lg-5">
        
        <!-- 1. MANUAL ADD -->
        <div class="card shadow-sm border-0 mb-4">
            <div class="card-header bg-dark text-white fw-bold">
                Add Manually
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="mb-3">
                        <label class="small text-muted">Item Name</label>
                        <input type="text" name="item_name" list="food_suggestions" class="form-control" placeholder="e.g., Eggs" required>
                        <datalist id="food_suggestions">
                            {% for s in suggestions %}<option value="{{ s }}">{% endfor %}
                        </datalist>
                    </div>
                    <div class="mb-3">
                        <label class="small text-muted">Price (Optional)</label>
                        <div class="input-group">
                            <span class="input-group-text">$</span>
                            <input type="number" step="0.01" name="item_price" class="form-control" placeholder="Auto">
                        </div>
                    </div>
                    <button type="submit" name="add_item" value="1" class="btn btn-success w-100">Add to Cart</button>
                </form>
            </div>
        </div>

        <!-- 2. AI GENERATOR -->
        <div class="card shadow-sm border-0 bg-primary text-white" style="background: linear-gradient(45deg, #4b6cb7, #182848);">
            <div class="card-body text-center p-4">
                <i class="fas fa-magic fa-2x mb-3"></i>
                <h5 class="fw-bold">AI Budget Planner</h5>
                <p class="small opacity-75">
                    Generate a complete {{ current_user.budget_period.lower() }} shopping list that fits perfectly within your ${{ current_user.budget_amount }} budget.
                </p>
                <a href="/generate_ai_list" class="btn btn-light fw-bold text-primary w-100">
                    <i class="fas fa-bolt me-2"></i>Auto-Fill My List
                </a>
            </div>
        </div>
    </div>
</div>

<!-- JAVASCRIPT FIX: Quotes around the Jinja variable make it valid string, then we parse it to number -->
<script>
    var progressVal = parseFloat("{{ progress }}");
    
    // Cap the visual width at 100% so it doesn't overflow
    if (progressVal > 100) progressVal = 100;
    
    document.getElementById('budgetProgressBar').style.width = progressVal + "%";
</script>

{% endblock %}
